<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Relatório do Paciente - MoveOn</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="page">
        <div class="card">
            <div class="top">
                <a class="back" href="/fisio_area">← Voltar para pacientes</a>
            </div>

            <h1>Relatório de Progresso</h1>
            <p class="sub" id="p-name">Carregando dados do paciente...</p>

            <!-- Filtros de Período -->
            <div class="row-actions" style="margin-bottom: 20px;">
                <button onclick="carregarRelatorio('last_week', this)" class="btn btn-secondary btn-small">Última
                    Semana</button>
                <button onclick="carregarRelatorio('last_month', this)" class="btn btn-small">Último Mês</button>
                <button onclick="carregarRelatorio('last_3_months', this)" class="btn btn-secondary btn-small">3
                    Meses</button>
            </div>

            <!-- Cards de Resumo -->
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 24px;">
                <div class="card"
                    style="padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center;">
                    <span style="display:block; font-size: 0.85rem; color: #64748b;">Aderência</span>
                    <strong style="font-size: 1.4rem; color: #0f172a;" id="stat-aderencia">-%</strong>
                </div>
                <div class="card"
                    style="padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center;">
                    <span style="display:block; font-size: 0.85rem; color: #64748b;">Dor Média</span>
                    <strong style="font-size: 1.4rem; color: #0f172a;" id="stat-dor">-</strong>
                </div>
                <div class="card"
                    style="padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center;">
                    <span style="display:block; font-size: 0.85rem; color: #64748b;">Conclusão</span>
                    <strong style="font-size: 1.4rem; color: #0f172a;" id="stat-conclusao">-%</strong>
                </div>
            </div>

            <!-- Gráfico (Placeholder) -->
            <div style="height: 250px; margin-bottom: 24px;">
                <canvas id="chartProgresso"></canvas>
            </div>

            <div style="margin-top: 10px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                <h3>Feedback automático (vídeo enviado pelo paciente)</h3>
                <div id="videos-status" style="font-size:0.9rem; color:#6b7280; margin-top:6px;">Carregando vídeos...</div>
                <div id="lista-videos" style="margin-top: 10px;"></div>
            </div>

            <!-- Histórico de Execuções -->
            <h3 style="margin-top:24px;">Execuções (dados)</h3>
            <table style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Exercício</th>
                        <th>Status</th>
                        <th>Dor</th>
                        <th>Comentário do fisioterapeuta</th>
                    </tr>
                </thead>
                <tbody id="lista-execucoes">
                    <tr>
                        <td colspan="5" style="text-align:center">Selecione um período...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        window.API_BASE = window.API_BASE || "http://127.0.0.1:8000/api";
        var API_BASE = window.API_BASE;
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get("patient_id");
        let chartInstance = null;

        const fisio = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");

        if (!patientId) {
            alert("Paciente não especificado");
            window.location.href = "/fisio_area";
        }

        let periodoSelecionado = 'last_month';
        let refreshTimer = null;

        function atualizarBotoesPeriodo(botaoAtivo) {
            document.querySelectorAll('.row-actions button').forEach(b => {
                b.classList.remove('btn');
                b.classList.add('btn-secondary');
            });
            if (botaoAtivo) {
                botaoAtivo.classList.remove('btn-secondary');
                botaoAtivo.classList.add('btn');
            }
        }

        async function carregarRelatorio(periodo, botaoAtivo) {
            // manter estado de período e destacar botão quando houver
            if (periodo) periodoSelecionado = periodo;
            atualizarBotoesPeriodo(botaoAtivo);

            const tbody = document.getElementById("lista-execucoes");
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Buscando dados...</td></tr>`;

            try {
                const resp = await fetch(`${API_BASE}/patients/${patientId}/reports?period_filter=${periodoSelecionado}`);
                const data = await resp.json();

                if (!resp.ok) {
                    tbody.innerHTML = `<tr><td colspan="5">Erro ao carregar relatório</td></tr>`;
                    return;
                }

                document.getElementById("p-name").textContent = `Paciente: ${data.patient_name || "Desconhecido"}`;

                // Atualizar Stats
                document.getElementById("stat-aderencia").textContent = (data.progress.adherence_rate || 0) + "%";
                document.getElementById("stat-dor").textContent = (data.progress.pain_level_avg || "-");
                document.getElementById("stat-conclusao").textContent = (data.progress.completion_rate_avg || 0) + "%";

                renderizarGrafico(data.executions);

                if (!data.has_data || data.executions.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 30px; color: #64748b">Nenhuma atividade registrada neste período.</td></tr>`;
                    return;
                }

                tbody.innerHTML = "";
                data.executions.forEach(exec => {
                    const date = new Date(exec.execution_date).toLocaleDateString('pt-BR');
                    const exerciseName = exec.exercise ? exec.exercise.name : "Exercício removido";

                    // Dor (pegar a maior ou média, aqui pegando a primeira se houver)
                    const dor = exec.pain_levels.length > 0 ? exec.pain_levels[0].pain_level : "-";

                                        // Comentário do fisioterapeuta (mostrar o mais recente)
                                        const fbList = Array.isArray(exec.feedbacks) ? exec.feedbacks : [];
                                        const lastFb = fbList.length > 0 ? fbList[0] : null;
                                        const fbText = lastFb && lastFb.content ? lastFb.content : "-";

                    tbody.innerHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${exerciseName}</td>
                            <td>${exec.was_completed ? '<span class="badge badge-green">Concluído</span>' : '<span class="badge badge-gray">Incompleto</span>'}</td>
                            <td>${dor}</td>
                                                        <td style="font-size:0.85rem; color:#64748b; max-width: 260px;">
                                                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${fbText}">${fbText}</div>
                                                            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                                                                <select id="fb-type-${exec.id}" class="btn btn-secondary btn-small" style="padding:6px 10px;">
                                                                    <option value="neutral">Neutro</option>
                                                                    <option value="positive">Positivo</option>
                                                                    <option value="negative">Negativo</option>
                                                                </select>
                                                                <button class="btn btn-small" onclick="toggleFeedbackForm(${exec.id})">Adicionar feedback</button>
                                                            </div>
                                                            <div id="fb-form-${exec.id}" style="display:none; margin-top:8px;">
                                                                <textarea id="fb-text-${exec.id}" rows="3" style="width:100%; resize:vertical" placeholder="Escreva o feedback para o paciente..."></textarea>
                                                                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                                                    <button class="btn btn-small" onclick="salvarFeedback(${exec.id})">Salvar</button>
                                                                    <button class="btn btn-secondary btn-small" onclick="toggleFeedbackForm(${exec.id}, true)">Cancelar</button>
                                                                </div>
                                                                <div id="fb-msg-${exec.id}" style="margin-top:6px; font-size:0.85rem; color:#6b7280;"></div>
                                                            </div>
                                                        </td>
                        </tr>
                    `;
                });

                                // Carregar feedback automático do vídeo (independente do relatório)
                                carregarVideosFeedback();

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5">Erro de conexão</td></tr>`;
            }
        }

        function iniciarAutoRefresh() {
            // Atualiza continuamente enquanto a aba estiver visível
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if (document.visibilityState !== 'visible') return;
                carregarRelatorio(null, null);
            }, 15000);
        }

        function toggleFeedbackForm(executionId, forceHide) {
            const el = document.getElementById(`fb-form-${executionId}`);
            if (!el) return;
            if (forceHide) {
                el.style.display = 'none';
                return;
            }
            el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
        }

        async function salvarFeedback(executionId) {
            const msgEl = document.getElementById(`fb-msg-${executionId}`);
            const textEl = document.getElementById(`fb-text-${executionId}`);
            const typeEl = document.getElementById(`fb-type-${executionId}`);

            if (!fisio || fisio.tipo !== "fisioterapeuta" || !fisio.id) {
                if (msgEl) msgEl.textContent = "Faça login como fisioterapeuta.";
                return;
            }
            const content = (textEl && textEl.value) ? textEl.value.trim() : "";
            const feedbackType = (typeEl && typeEl.value) ? typeEl.value : "neutral";

            if (!content) {
                if (msgEl) msgEl.textContent = "Escreva um feedback antes de salvar.";
                return;
            }

            if (msgEl) msgEl.textContent = "Salvando...";

            try {
                const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/executions/${executionId}/feedbacks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        feedback_type: feedbackType,
                        content: content,
                    })
                });
                const data = await resp.json();

                if (!resp.ok) {
                    if (msgEl) msgEl.textContent = (data && data.detail) ? data.detail : "Erro ao salvar feedback.";
                    return;
                }

                if (msgEl) msgEl.textContent = "Feedback salvo.";
                if (textEl) textEl.value = "";
                toggleFeedbackForm(executionId, true);
                // Recarregar para mostrar no relatório imediatamente
                carregarRelatorio(null, null);
            } catch (e) {
                console.error(e);
                if (msgEl) msgEl.textContent = "Erro de conexão ao salvar feedback.";
            }
        }

        async function carregarVideosFeedback() {
            const statusEl = document.getElementById("videos-status");
            const listEl = document.getElementById("lista-videos");

            if (!fisio || fisio.tipo !== "fisioterapeuta" || !fisio.id) {
                statusEl.textContent = "Faça login como fisioterapeuta para ver o feedback automático.";
                listEl.innerHTML = "";
                return;
            }

            statusEl.textContent = "Carregando vídeos...";
            listEl.innerHTML = "";

            try {
                const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/video-feedbacks`);
                if (!resp.ok) {
                    statusEl.textContent = "Não foi possível carregar os vídeos (sem acesso ou erro).";
                    return;
                }
                const data = await resp.json();
                if (!Array.isArray(data) || data.length === 0) {
                    statusEl.textContent = "Nenhum vídeo enviado ainda.";
                    return;
                }

                statusEl.textContent = "";
                data.forEach((fb) => {
                    const card = document.createElement("div");
                    card.className = "card";
                    card.style.boxShadow = "none";
                    card.style.border = "1px solid #e5e7eb";
                    card.style.marginBottom = "10px";

                    const ts = fb.timestamp ? new Date(fb.timestamp).toLocaleString('pt-BR') : "data desconhecida";
                    const obs = Array.isArray(fb.observacoes) && fb.observacoes.length
                        ? `<ul style='margin:6px 0 0 0; padding-left:18px; color:#374151; font-size:0.93em'>${fb.observacoes.map(o=>`<li>${o}</li>`).join('')}</ul>`
                        : "";
                    const detalhes = Array.isArray(fb.detalhes) && fb.detalhes.length
                        ? `<details style='margin-top:6px'><summary>Detalhes das repetições</summary><ul style='margin:4px 0 0 0; padding-left:18px; color:#374151; font-size:0.92em'>${fb.detalhes.map(rep => `<li>Rep ${rep.rep_index}: ${rep.note} (Ângulo: ${rep.min_angle?.toFixed?.(1) ?? rep.min_angle}° - ${rep.max_angle?.toFixed?.(1) ?? rep.max_angle}°)</li>`).join('')}</ul></details>`
                        : "";

                    let videoHtml = "";
                    if (fb.video_filename) {
                        const videoUrl = `${API_BASE}/videos/${encodeURIComponent(fb.video_filename)}`;
                        videoHtml = `
                          <div style='margin-top:10px'>
                            <video controls style='width:100%; max-height:320px; border-radius:12px; background:#111827' src='${videoUrl}'></video>
                            <div style='margin-top:6px; font-size:0.85rem'>
                              <a href='${videoUrl}' target='_blank' rel='noopener'>Baixar/abrir vídeo</a>
                            </div>
                          </div>
                        `;
                    } else {
                        videoHtml = `<div style='margin-top:10px; font-size:0.9rem; color:#6b7280'>Vídeo não disponível (log antigo sem referência ao arquivo).</div>`;
                    }

                    card.innerHTML = `
                      <div style='font-size:0.95rem; color:#0369a1; margin-bottom:4px'><b>${fb.exercise_name || `Exercício ID: ${fb.exercise_id || "?"}`}</b> (${ts})</div>
                      <div style='font-size:0.95rem; color:#374151; margin-bottom:4px'><b>Status:</b> ${fb.status || '-'}</div>
                      <div style='font-size:0.95rem; color:#374151; margin-bottom:4px'><b>Repetições detectadas:</b> ${fb.repeticoes ?? '-'}</div>
                      ${obs}
                      ${detalhes}
                      ${videoHtml}
                    `;

                    listEl.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                statusEl.textContent = "Erro de conexão ao carregar vídeos.";
            }
        }

        function renderizarGrafico(executions) {
            const ctx = document.getElementById('chartProgresso');
            if (chartInstance) chartInstance.destroy();

            // Preparar dados: dor por data
            // Ordenar por data (está desc, inverter para asc)
            const sorted = [...executions].reverse();
            const labels = sorted.map(e => new Date(e.execution_date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            const dataDor = sorted.map(e => (e.pain_levels.length > 0 ? e.pain_levels[0].pain_level : null));

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nível de Dor',
                        data: dataDor,
                        borderColor: '#dc2626',
                        backgroundColor: '#fee2e2',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 10 }
                    }
                }
            });
        }

        // Carregar inicial
        document.addEventListener("DOMContentLoaded", () => {
            // Seleciona o botão de "Último Mês" como ativo no load
            const btnMes = document.querySelector('.row-actions button:nth-child(2)');
            carregarRelatorio('last_month', btnMes);
            carregarVideosFeedback();
            iniciarAutoRefresh();
        });

        document.addEventListener('visibilitychange', () => {
            // Ao voltar para a aba, puxa na hora (sem esperar 15s)
            if (document.visibilityState === 'visible') {
                carregarRelatorio(null, null);
            }
        });
    </script>
    <script>
        (function(){
            document.querySelectorAll('a[href$=".html"]').forEach(a=>{
                const href = a.getAttribute('href');
                if (!href.match(/^https?:\/\//)) {
                    const p = href.replace(/^(?:\.\/|\/)*/,'').replace(/\.html$/,'');
                    a.setAttribute('href','/' + p);
                }
            });
        })();
    </script>
</body>

</html>