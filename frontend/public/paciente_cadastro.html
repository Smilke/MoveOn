<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Cadastrar Paciente - MoveOn</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .page {
      width: 100%;
      max-width: 720px;
      padding: 24px 16px 32px;
      box-sizing: border-box
    }

    .card {
      background: #fff;
      border-radius: 18px;
      padding: 24px 24px 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, .12)
    }

    .top-link {
      display: inline-block;
      margin-bottom: 12px;
      font-size: .85rem;
      color: #4b5563;
      text-decoration: none
    }

    .top-link:hover {
      text-decoration: underline
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.5rem;
      color: #111827
    }

    p.sub {
      margin: 0 0 16px;
      font-size: .9rem;
      color: #6b7280
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px 16px;
      margin-top: 12px
    }

    @media (min-width:640px) {
      .grid {
        grid-template-columns: 1fr 1fr
      }
    }

    label {
      display: block;
      font-size: .85rem;
      color: #374151;
      margin-bottom: 2px
    }

    input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: .9rem;
      box-sizing: border-box
    }

    input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb33
    }

    .full {
      grid-column: 1/-1
    }

    .btn {
      margin-top: 16px;
      width: 100%;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      font-size: .95rem;
      cursor: pointer
    }

    .btn:hover {
      background: #1d4ed8
    }

    .msg-ok,
    .msg-err {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: .85rem;
      display: none
    }

    .msg-ok {
      background: #ecfdf5;
      color: #166534
    }

    .msg-err {
      background: #fee2e2;
      color: #b91c1c
    }

    .hint {
      font-size: .82rem;
      color: #6b7280;
      margin-top: 8px
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <a href="/fisio_area" class="top-link">← Voltar para a área do fisioterapeuta</a>

      <h1>Cadastrar paciente</h1>
      <p class="sub">
        Cadastre um novo paciente para vincular ao sistema.
      </p>

      <div class="grid">
        <div class="full">
          <label for="nome">Nome completo do paciente</label>
          <input id="nome" type="text" placeholder="Ex.: Maria da Silva" />
        </div>

        <div>
          <label for="email">E-mail do paciente</label>
          <input id="email" type="email" placeholder="maria@email.com" />
        </div>

        <div>
          <label for="phone">Telefone (opcional)</label>
          <input id="phone" type="text" placeholder="(83) 99999-9999" />
        </div>

        <div class="full">
          <label for="birth_date">Data de nascimento (opcional)</label>
          <input id="birth_date" type="date" />
        </div>

        <div class="full">
          <label for="cpf_fisio">CPF do fisioterapeuta responsável</label>
          <input id="cpf_fisio" type="text" placeholder="apenas números" />
        </div>
      </div>

      <button class="btn" onclick="cadastrarPacienteDB()">Cadastrar no banco</button>


      <div id="ok" class="msg-ok"></div>
      <div id="err" class="msg-err"></div>
    </div>
  </div>

  <script>
    window.API_BASE = window.API_BASE || "http://127.0.0.1:8000/api";
    var API_BASE = window.API_BASE;

    function showOk(msg) {
      const ok = document.getElementById("ok");
      const err = document.getElementById("err");
      err.style.display = "none"; err.textContent = "";
      ok.textContent = msg; ok.style.display = "block";
    }
    function showErr(msg) {
      const ok = document.getElementById("ok");
      const err = document.getElementById("err");
      ok.style.display = "none"; ok.textContent = "";
      err.textContent = msg; err.style.display = "block";
    }
    function parseDetail(d) {
      if (!d) return "Ocorreu um erro.";
      if (Array.isArray(d)) return d.join(" ");
      return String(d);
    }

    async function cadastrarPacienteDB() {
      const name = document.getElementById("nome").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const birth_date = document.getElementById("birth_date").value;
      const cpf_fisio = document.getElementById("cpf_fisio").value.trim();

      if (!name || !email || !cpf_fisio) {
        showErr("Preencha: nome, email e CPF do fisioterapeuta.");
        return;
      }

      // payload do banco (PatientCreate)
      const body = {
        name,
        email,
        phone: phone || null,
        birth_date: birth_date ? new Date(birth_date).toISOString() : null,
        physiotherapist_cpf: cpf_fisio   // <-- usa CPF do fisio e o backend resolve o ID
      };

      try {
        const resp = await fetch(`${API_BASE}/patients`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          showErr(parseDetail(data.detail) || `Erro (${resp.status})`);
          return;
        }

        // esperável: retornar o PatientResponse com id
        showOk(`Paciente cadastrado! ID no banco: ${data.id}`);

        // limpa campos
        document.getElementById("nome").value = "";
        document.getElementById("email").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("birth_date").value = "";
        // cpf do fisio pode ficar, pra cadastrar vários pacientes seguidos
        // document.getElementById("cpf_fisio").value="";
      } catch (e) {
        console.error(e);
        showErr("Erro inesperado ao cadastrar paciente.");
      }
    }
  </script>
  <script>
    (function () {
      document.querySelectorAll('a[href$=".html"]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href.match(/^https?:\/\//)) {
          const p = href.replace(/^(?:\.\/|\/)*/, '').replace(/\.html$/, '');
          a.setAttribute('href', '/' + p);
        }
      });
    })();
  </script>
</body>

</html>