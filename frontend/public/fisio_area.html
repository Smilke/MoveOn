<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>√Årea do Fisioterapeuta - MoveOn</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="top">
        <div>
          <h1>Meus Pacientes</h1>
          <p class="sub">Gerencie seus pacientes e prescreva exerc√≠cios</p>
        </div>
        <div class="row-actions" style="margin-top:0">
          <a href="/lista_exercicios" class="btn btn-secondary btn-small">üìö Biblioteca de Exerc√≠cios</a>
          <button onclick="logout()" class="btn btn-secondary btn-small">Sair</button>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" onclick="abrirModalNovoPaciente()">+ Novo Paciente</button>
      </div>

      <table style="margin-top: 24px;">
        <thead>
          <tr>
            <th width="50">ID</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>Email</th>
            <th style="text-align:right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="lista-pacientes">
          <tr>
            <td colspan="5" style="text-align:center">Carregando...</td>
          </tr>
        </tbody>
      </table>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <!-- Modal Simples (via CSS inline pra simplificar) -->
  <div id="modal-novo"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="card" style="width: 400px; max-width:90%;">
      <h2>Novo Paciente</h2>
      <div class="grid">
        <div class="full">
          <label>Nome</label>
          <input type="text" id="novo-nome">
        </div>
        <div class="full">
          <label>Email</label>
          <input type="email" id="novo-email">
        </div>
        <div class="full">
          <label>CPF</label>
          <input type="text" id="novo-cpf" placeholder="Somente n√∫meros">
        </div>
        <div class="full">
          <button class="btn" onclick="criarPaciente()">Salvar</button>
          <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.API_BASE = window.API_BASE || "http://127.0.0.1:8000/api";
    var API_BASE = window.API_BASE;
    const fisio = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");

    const expandedPatients = new Set();
    const pendingVideoPatients = new Set();
    let videosRefreshTimer = null;

    if (!fisio || fisio.tipo !== "fisioterapeuta") {
      window.location.href = "/login";
    }

    async function carregarPacientes() {
      const tbody = document.getElementById("lista-pacientes");
      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients`);
        const data = await resp.json();

        if (!resp.ok) {
          tbody.innerHTML = `<tr><td colspan="5">Erro ao carregar pacientes</td></tr>`;
          return;
        }

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Nenhum paciente cadastrado.</td></tr>`;
          return;
        }

        tbody.innerHTML = "";
        data.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                        <td>#${p.id}</td>
                        <td>${p.name}</td>
                        <td style="font-family: monospace;">${p.cpf || '-'}</td>
                        <td>${p.email}</td>
                        <td style="text-align:right">
                            <div class="btn-group">
                              <a href="/prescricao_exercicio?patient_id=${p.id}" class="btn btn-small">Prescrever</a>
                              <a href="/fisio_metas?patient_id=${p.id}" class="btn btn-secondary btn-small">Metas</a>
                              <a href="/relatorio_paciente?patient_id=${p.id}" class="btn btn-secondary btn-small">Relat√≥rio</a>
                              <button class="btn btn-secondary btn-small" onclick="togglePrescricoes(${p.id})">Prescri√ß√µes</button>
                              <button class="btn btn-secondary btn-small" onclick="removerPaciente(${p.id})">Remover</button>
                            </div>
                        </td>
                    `;
          tbody.appendChild(tr);

          const trPrescs = document.createElement("tr");
          trPrescs.id = `prescs-row-${p.id}`;
          trPrescs.style.display = "none";
          trPrescs.innerHTML = `
                        <td colspan="5">
                          <div id="prescs-${p.id}" class="hint">Carregando prescri√ß√µes...</div>
                          <div style="margin-top:16px; border-top:1px solid #e5e7eb; padding-top:14px;">
                            <h3 style="font-size: 1rem; color: #4b5563; margin:0">V√≠deos enviados e an√°lise</h3>
                            <div id="videos-status-${p.id}" style="font-size:0.9rem; color:#6b7280; margin-top:6px;">Carregando v√≠deos...</div>
                            <div id="lista-videos-${p.id}" style="margin-top: 10px;"></div>
                          </div>
                        </td>
                    `;
          tbody.appendChild(trPrescs);
        });

      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="5">Erro de conex√£o</td></tr>`;
      }
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function togglePrescricoes(patientId) {
      const row = document.getElementById(`prescs-row-${patientId}`);
      if (!row) return;

      const isHidden = row.style.display === "none" || row.style.display === "";
      if (isHidden) {
        row.style.display = "";
        expandedPatients.add(patientId);
        await carregarPrescricoes(patientId);
      } else {
        row.style.display = "none";
        expandedPatients.delete(patientId);
        pendingVideoPatients.delete(patientId);
        updateVideosAutoRefresh();
      }
    }

    function updateVideosAutoRefresh() {
      if (videosRefreshTimer) {
        clearInterval(videosRefreshTimer);
        videosRefreshTimer = null;
      }
      if (pendingVideoPatients.size === 0) return;
      videosRefreshTimer = setInterval(() => {
        if (document.visibilityState !== 'visible') return;
        expandedPatients.forEach((pid) => {
          if (pendingVideoPatients.has(pid)) carregarVideosPaciente(pid);
        });
      }, 10000);
    }

    async function carregarPrescricoes(patientId) {
      const box = document.getElementById(`prescs-${patientId}`);
      if (!box) return;

      box.innerHTML = "Carregando prescri√ß√µes...";

      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/prescriptions?active_only=false`);
        const data = await resp.json();

        if (!resp.ok) {
          const msg = (data && (data.detail || data.message)) ? (data.detail || data.message) : "Erro ao carregar prescri√ß√µes";
          box.innerHTML = `<div class="msg err">${escapeHtml(msg)}</div>`;
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          box.innerHTML = `<div class="msg">Nenhuma prescri√ß√£o encontrada para este paciente.</div>`;
          return;
        }

        const items = data.map(pr => {
          const exerciseName = pr.exercise && pr.exercise.name ? pr.exercise.name : `Exerc√≠cio #${pr.exercise_id}`;
          const badge = pr.is_active
            ? `<span class="badge badge-green">Ativa</span>`
            : `<span class="badge badge-gray">Desativada</span>`;

          const details = `Reps: ${pr.repetitions} ‚Ä¢ S√©ries: ${pr.series} ‚Ä¢ ${pr.weekly_frequency}x/sem`;
          const notes = pr.notes ? `<div style="margin-top:6px; color:#4b5563; font-size:0.9rem;">Obs: ${escapeHtml(pr.notes)}</div>` : "";

          const btnDesativar = pr.is_active
            ? `<button class="btn btn-secondary btn-small" onclick="desativarPrescricao(${patientId}, ${pr.id})">Desativar</button>`
            : "";

          const btnReativar = (!pr.is_active)
            ? `<button class="btn btn-secondary btn-small" onclick="reativarPrescricao(${patientId}, ${pr.id})">Reativar</button>`
            : "";

          const btnRemover = `<button class="btn btn-secondary btn-small" onclick="removerPrescricao(${patientId}, ${pr.id})">Remover</button>`;
          const btnEditar = `<a class="btn btn-secondary btn-small" href="/prescricao_exercicio?patient_id=${patientId}&prescription_id=${pr.id}">Editar</a>`;

          return `
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; padding:10px 0; border-bottom:1px solid #e5e7eb;">
              <div>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                  <strong>${escapeHtml(exerciseName)}</strong>
                  ${badge}
                </div>
                <div style="margin-top:6px; color:#4b5563; font-size:0.9rem;">${escapeHtml(details)}</div>
                ${notes}
              </div>
              <div class="btn-group">
                ${btnDesativar}${btnReativar}${btnRemover}${btnEditar}
              </div>
            </div>
          `;
        }).join("");

        box.innerHTML = `<div>${items}</div>`;

        // carregar v√≠deos do paciente na mesma √°rea
        carregarVideosPaciente(patientId);
      } catch (e) {
        console.error(e);
        box.innerHTML = `<div class="msg err">Erro de conex√£o ao carregar prescri√ß√µes.</div>`;
      }
    }

    async function carregarVideosPaciente(patientId) {
      const statusEl = document.getElementById(`videos-status-${patientId}`);
      const listEl = document.getElementById(`lista-videos-${patientId}`);
      if (!statusEl || !listEl) return;

      statusEl.textContent = 'Carregando v√≠deos...';
      listEl.innerHTML = '';

      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/video-feedbacks`);
        if (!resp.ok) {
          statusEl.textContent = 'N√£o foi poss√≠vel carregar os v√≠deos (sem acesso ou erro).';
          return;
        }
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
          statusEl.textContent = 'Nenhum v√≠deo enviado ainda.';
          pendingVideoPatients.delete(patientId);
          updateVideosAutoRefresh();
          return;
        }

        statusEl.textContent = '';
        let hasPendingProgress = false;
        data.forEach((fb) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.boxShadow = 'none';
          card.style.border = '1px solid #e5e7eb';
          card.style.marginBottom = '10px';

          const ts = fb.timestamp ? new Date(fb.timestamp).toLocaleString('pt-BR') : 'data desconhecida';

          function renderProgress(fb) {
            const status = (fb.status || '').toLowerCase();
            const isPending = status.includes('pendente') || status.includes('process') || status.includes('running');
            const raw = (fb && fb.progress !== undefined && fb.progress !== null) ? Number(fb.progress) : NaN;
            if (!isPending || Number.isNaN(raw)) return '';
            const pct = Math.max(0, Math.min(100, Math.round(raw)));
            const frames = (fb.frames_done !== undefined && fb.frames_total)
              ? ` (${escapeHtml(fb.frames_done)}/${escapeHtml(fb.frames_total)} frames)`
              : '';
            return `
              <div style='margin:8px 0 10px 0;'>
                <div style='display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; color:#6b7280; margin-bottom:6px;'>
                  <span>Progresso da an√°lise</span>
                  <span><b>${pct}%</b>${frames}</span>
                </div>
                <div style='height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden;'>
                  <div style='height:100%; width:${pct}%; background:#2563eb;'></div>
                </div>
              </div>
            `;
          }

          const progressHtml = renderProgress(fb);

          const statusLower = (fb.status || '').toLowerCase();
          const isPending = statusLower.includes('pendente') || statusLower.includes('process') || statusLower.includes('running');
          const hasProgress = (fb.progress !== null && fb.progress !== undefined);
          if (isPending && hasProgress) hasPendingProgress = true;

          const obs = Array.isArray(fb.observacoes) && fb.observacoes.length
            ? `<ul style='margin:6px 0 0 0; padding-left:18px; color:#374151; font-size:0.93em'>${fb.observacoes.map(o=>`<li>${escapeHtml(o)}</li>`).join('')}</ul>`
            : '';
          const detalhes = Array.isArray(fb.detalhes) && fb.detalhes.length
            ? `<details style='margin-top:6px'><summary>Detalhes das repeti√ß√µes</summary><ul style='margin:4px 0 0 0; padding-left:18px; color:#374151; font-size:0.92em'>${fb.detalhes.map(rep => `<li>Rep ${rep.rep_index}: ${escapeHtml(rep.note)} (√Çngulo: ${rep.min_angle?.toFixed?.(1) ?? rep.min_angle}¬∞ - ${rep.max_angle?.toFixed?.(1) ?? rep.max_angle}¬∞)</li>`).join('')}</ul></details>`
            : '';

          let videoHtml = '';
          if (fb.video_filename) {
            const videoUrl = `${API_BASE}/videos/${encodeURIComponent(fb.video_filename)}`;
            videoHtml = `
              <div style='margin-top:10px'>
                <video controls style='width:100%; max-height:320px; border-radius:12px; background:#111827' src='${videoUrl}'></video>
                <div style='margin-top:6px; font-size:0.85rem'>
                  <a href='${videoUrl}' target='_blank' rel='noopener'>Baixar/abrir v√≠deo</a>
                </div>
              </div>
            `;
          } else {
            videoHtml = `<div style='margin-top:10px; font-size:0.9rem; color:#6b7280'>V√≠deo n√£o dispon√≠vel (log antigo sem refer√™ncia ao arquivo).</div>`;
          }

          card.innerHTML = `
            <div style='font-size:0.95rem; color:#0369a1; margin-bottom:4px'><b>${escapeHtml(fb.exercise_name || `Exerc√≠cio ID: ${fb.exercise_id || "?"}`)}</b> (${escapeHtml(ts)})</div>
            <div style='font-size:0.95rem; color:#374151; margin-bottom:4px'><b>Status:</b> ${escapeHtml(fb.status || '-')}</div>
            ${progressHtml}
            <div style='font-size:0.95rem; color:#374151; margin-bottom:4px'><b>Repeti√ß√µes detectadas:</b> ${fb.repeticoes ?? '-'}</div>
            ${obs}
            ${detalhes}
            ${videoHtml}
          `;

          listEl.appendChild(card);
        });

        if (hasPendingProgress) pendingVideoPatients.add(patientId);
        else pendingVideoPatients.delete(patientId);
        updateVideosAutoRefresh();
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Erro de conex√£o ao carregar v√≠deos.';
        pendingVideoPatients.delete(patientId);
        updateVideosAutoRefresh();
      }
    }

    async function desativarPrescricao(patientId, prescriptionId) {
      const box = document.getElementById(`prescs-${patientId}`);
      if (box) box.innerHTML = "Desativando prescri√ß√£o...";

      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/prescriptions/${prescriptionId}`, {
          method: "DELETE",
        });

        let data = null;
        try { data = await resp.json(); } catch (e) { /* ignore */ }

        if (!resp.ok) {
          const msg = data && (data.detail || data.message) ? (data.detail || data.message) : "Erro ao remover prescri√ß√£o";
          if (box) box.innerHTML = `<div class="msg err">${escapeHtml(msg)}</div>`;
          return;
        }

        await carregarPrescricoes(patientId);
      } catch (e) {
        console.error(e);
        if (box) box.innerHTML = `<div class="msg err">Erro de conex√£o ao remover prescri√ß√£o.</div>`;
      }
    }

    async function reativarPrescricao(patientId, prescriptionId) {
      const box = document.getElementById(`prescs-${patientId}`);
      if (box) box.innerHTML = "Reativando prescri√ß√£o...";

      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/prescriptions/${prescriptionId}/reactivate`, {
          method: "PATCH",
        });

        let data = null;
        try { data = await resp.json(); } catch (e) { /* ignore */ }

        if (!resp.ok) {
          const msg = data && (data.detail || data.message) ? (data.detail || data.message) : "Erro ao reativar prescri√ß√£o";
          if (box) box.innerHTML = `<div class="msg err">${escapeHtml(msg)}</div>`;
          return;
        }

        await carregarPrescricoes(patientId);
      } catch (e) {
        console.error(e);
        if (box) box.innerHTML = `<div class="msg err">Erro de conex√£o ao reativar prescri√ß√£o.</div>`;
      }
    }

    async function removerPrescricao(patientId, prescriptionId) {
      const box = document.getElementById(`prescs-${patientId}`);
      if (box) box.innerHTML = "Removendo prescri√ß√£o...";

      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}/prescriptions/${prescriptionId}/permanent`, {
          method: "DELETE",
        });

        let data = null;
        try { data = await resp.json(); } catch (e) { /* ignore */ }

        if (!resp.ok) {
          const msg = data && (data.detail || data.message) ? (data.detail || data.message) : "Erro ao remover prescri√ß√£o";
          if (box) box.innerHTML = `<div class="msg err">${escapeHtml(msg)}</div>`;
          return;
        }

        await carregarPrescricoes(patientId);
      } catch (e) {
        console.error(e);
        if (box) box.innerHTML = `<div class="msg err">Erro de conex√£o ao remover prescri√ß√£o.</div>`;
      }
    }

    async function removerPaciente(patientId) {
      const ok = confirm(`Remover permanentemente o paciente #${patientId}?\n\nIsso tamb√©m remove prescri√ß√µes, execu√ß√µes e metas vinculadas.`);
      if (!ok) return;

      try {
        const resp = await fetch(`${API_BASE}/physiotherapists/${fisio.id}/patients/${patientId}`, {
          method: "DELETE",
        });

        let data = null;
        try { data = await resp.json(); } catch (e) { /* ignore */ }

        if (!resp.ok) {
          const msg = data && (data.detail || data.message) ? (data.detail || data.message) : "Erro ao remover paciente";
          alert(msg);
          return;
        }

        expandedPatients.delete(patientId);
        pendingVideoPatients.delete(patientId);
        updateVideosAutoRefresh();
        await carregarPacientes();
      } catch (e) {
        console.error(e);
        alert("Erro de conex√£o ao remover paciente");
      }
    }

    function abrirModalNovoPaciente() {
      document.getElementById("modal-novo").style.display = "flex";
    }
    function fecharModal() {
      document.getElementById("modal-novo").style.display = "none";
    }

    async function criarPaciente() {
      const name = document.getElementById("novo-nome").value;
      const email = document.getElementById("novo-email").value;
      const cpf = document.getElementById("novo-cpf").value;

      if (!name || !email || !cpf) return alert("Preencha nome, email e CPF");

      try {
        const fisio = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");
        const payload = { name, email, cpf };
        if (fisio && fisio.tipo === 'fisioterapeuta' && fisio.id) payload.physiotherapist_id = fisio.id;

        const resp = await fetch(`${API_BASE}/patients`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (resp.ok) {
          alert("Paciente criado!");
          fecharModal();
          carregarPacientes();
        } else {
          // Try to surface server error details
          let errText = "Desconhecido";
          try {
            const err = await resp.json();
            errText = err.detail || JSON.stringify(err);
          } catch (e) {
            errText = await resp.text();
          }
          alert("Erro: " + errText);
        }
      } catch (e) {
        console.error(e);
        alert("Erro de conex√£o");
      }
    }

    function logout() {
      localStorage.removeItem("moveon_usuario_logado");
      window.location.href = "/login";
    }

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        updateVideosAutoRefresh();
      } else {
        if (videosRefreshTimer) {
          clearInterval(videosRefreshTimer);
          videosRefreshTimer = null;
        }
      }
    });

    document.addEventListener("DOMContentLoaded", carregarPacientes);
  </script>
  <script>
    (function () {
      document.querySelectorAll('a[href$=".html"]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href.match(/^https?:\/\//)) {
          const p = href.replace(/^(?:\.\/|\/)*/, '').replace(/\.html$/, '');
          a.setAttribute('href', '/' + p);
        }
      });
    })();
  </script>
</body>

</html>