<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>√Årea do Fisioterapeuta - MoveOn</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="top">
        <div>
          <h1>Meus Pacientes</h1>
          <p class="sub">Gerencie seus pacientes e prescreva exerc√≠cios</p>
        </div>
        <div class="row-actions" style="margin-top:0">
          <a href="/lista_exercicios" class="btn btn-secondary btn-small">üìö Biblioteca de Exerc√≠cios</a>
          <button onclick="logout()" class="btn btn-secondary btn-small">Sair</button>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" onclick="abrirModalNovoPaciente()">+ Novo Paciente</button>
      </div>

      <table style="margin-top: 24px;">
        <thead>
          <tr>
            <th width="50">ID</th>
            <th>Nome</th>
            <th>Email</th>
            <th style="text-align:right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="lista-pacientes">
          <tr>
            <td colspan="4" style="text-align:center">Carregando...</td>
          </tr>
        </tbody>
      </table>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <!-- Modal Simples (via CSS inline pra simplificar) -->
  <div id="modal-novo"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="card" style="width: 400px; max-width:90%;">
      <h2>Novo Paciente</h2>
      <div class="grid">
        <div class="full">
          <label>Nome</label>
          <input type="text" id="novo-nome">
        </div>
        <div class="full">
          <label>Email</label>
          <input type="email" id="novo-email">
        </div>
        <div class="full">
          <button class="btn" onclick="criarPaciente()">Salvar</button>
          <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api";
    const fisio = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");

    if (!fisio || fisio.tipo !== "fisioterapeuta") {
      window.location.href = "/login";
    }

    async function carregarPacientes() {
      const tbody = document.getElementById("lista-pacientes");
      try {
        const resp = await fetch(`${API_BASE}/patients`);
        const data = await resp.json();

        if (!resp.ok) {
          tbody.innerHTML = `<tr><td colspan="4">Erro ao carregar pacientes</td></tr>`;
          return;
        }

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">Nenhum paciente cadastrado.</td></tr>`;
          return;
        }

        tbody.innerHTML = "";
        data.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                        <td>#${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.email}</td>
                        <td style="text-align:right">
                            <a href="/prescricao_exercicio?patient_id=${p.id}" class="btn btn-small">Prescrever</a>
                            <a href="/relatorio_paciente?patient_id=${p.id}" class="btn btn-secondary btn-small">Relat√≥rio</a>
                        </td>
                    `;
          tbody.appendChild(tr);
        });

      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="4">Erro de conex√£o</td></tr>`;
      }
    }

    function abrirModalNovoPaciente() {
      document.getElementById("modal-novo").style.display = "flex";
    }
    function fecharModal() {
      document.getElementById("modal-novo").style.display = "none";
    }

    async function criarPaciente() {
      const name = document.getElementById("novo-nome").value;
      const email = document.getElementById("novo-email").value;

      if (!name || !email) return alert("Preencha nome e email");

      try {
        // Attach physiotherapist id when creating patient from fisioterapeuta UI
        const fisio = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");
        const payload = { name, email };
        if (fisio && fisio.tipo === 'fisioterapeuta' && fisio.id) payload.physiotherapist_id = fisio.id;

        const resp = await fetch(`${API_BASE}/patients`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (resp.ok) {
          alert("Paciente criado!");
          fecharModal();
          carregarPacientes();
        } else {
          // Try to surface server error details
          let errText = "Desconhecido";
          try {
            const err = await resp.json();
            errText = err.detail || JSON.stringify(err);
          } catch(e) {
            errText = await resp.text();
          }
          alert("Erro: " + errText);
        }
      } catch (e) {
        console.error(e);
        alert("Erro de conex√£o");
      }
    }

    function logout() {
      localStorage.removeItem("moveon_usuario_logado");
      window.location.href = "/login";
    }

    document.addEventListener("DOMContentLoaded", carregarPacientes);
  </script>
  <script>
    (function(){
      document.querySelectorAll('a[href$=".html"]').forEach(a=>{
        const href = a.getAttribute('href');
        if (!href.match(/^https?:\/\//)) {
          const p = href.replace(/^(?:\.\/|\/)*/,'').replace(/\.html$/,'');
          a.setAttribute('href','/' + p);
        }
      });
    })();
  </script>
</body>

</html>