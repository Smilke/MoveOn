<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Minha √Årea - MoveOn</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="top">
        <div>
          <h1>Ol√°, <span id="nome-paciente">Paciente</span> üëã</h1>
          <p class="sub">Bem-vindo ao seu painel de reabilita√ß√£o</p>
        </div>
        <div class="row-actions" style="margin-top:0">
          <a href="/relatorio_meu" class="btn btn-secondary btn-small">Meu relat√≥rio</a>
          <button onclick="logout()" class="btn btn-secondary btn-small">Sair</button>
        </div>
      </div>

      <div style="margin-top: 30px;">
        <h2 style="font-size: 1.2rem; margin-bottom: 15px;">Meus Exerc√≠cios Ativos</h2>
        <div id="lista-exercicios" class="grid">
          <div style="text-align:center; padding: 20px; color: #6b7280;" class="full">Carregando seus exerc√≠cios...
          </div>
        </div>
      </div>

      <div style="margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
        <h3 style="font-size: 1rem; color: #4b5563;">Hist√≥rico Recente</h3>
        <div id="historico-recente" style="margin-top: 10px;">
          <p style="font-size: 0.9rem; color: #9ca3af;">Nenhuma atividade recente encontrada.</p>
        </div>
      </div>

      <div style="margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
        <h3 style="font-size: 1rem; color: #4b5563;">Feedback dos V√≠deos Enviados</h3>
        <div id="feedback-videos" style="margin-top: 10px;">
          <div id="feedback-videos-status" style="font-size: 0.9rem; color: #f59e42; display:none; align-items:center; gap:8px; margin-bottom:8px;">
            <span style="font-size:1.2em">‚è≥</span> Seu v√≠deo est√° sendo analisado, o feedback aparecer√° aqui em breve.
          </div>
          <div id="feedback-videos-none" style="font-size: 0.9rem; color: #9ca3af; display:none;">Nenhum v√≠deo pendente ou feedback encontrado.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.API_BASE = window.API_BASE || "http://127.0.0.1:8000/api";
    var API_BASE = window.API_BASE;
    const usuario = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");

    if (!usuario || usuario.tipo !== "paciente") {
      window.location.href = "/login";
    }

    document.getElementById("nome-paciente").textContent = usuario.nome;

    async function carregarExercicios() {
      const container = document.getElementById("lista-exercicios");
      try {
        const resp = await fetch(`${API_BASE}/patients/${usuario.id}/prescriptions?active_only=true`);
        const data = await resp.json();

        if (!resp.ok) {
          container.innerHTML = `<div class="full msg err">Erro ao carregar exerc√≠cios</div>`;
          return;
        }

        if (data.length === 0) {
          container.innerHTML = `<div class="full hint">Voc√™ n√£o tem exerc√≠cios prescritos no momento.</div>`;
          return;
        }

        container.innerHTML = "";
        data.forEach(p => {
          // Calcular se j√° fez hoje? (Futuro)

          const el = document.createElement("div");
          el.className = "card";
          el.style.boxShadow = "none";
          el.style.border = "1px solid #e5e7eb";
          el.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start">
                            <div>
                                <span class="badge badge-blue" style="margin-bottom:6px; display:inline-block">${p.exercise.category || "Geral"}</span>
                                <h3 style="margin:5px 0; font-size:1.1rem">${p.exercise.name}</h3>
                                <p style="font-size:0.9rem; color:#6b7280; margin:0">
                                    ${p.series} s√©ries de ${p.repetitions} repeti√ß√µes
                                </p>
                            </div>
                            <a href="/realizar_exercicio?prescription_id=${p.id}" class="btn btn-small">Come√ßar ‚ñ∂</a>
                        </div>
                        ${p.notes ? `<div style="margin-top:10px; font-size:0.85rem; color:#4b5563; background:#f9fafb; padding:8px; border-radius:8px">üìù ${p.notes}</div>` : ''}
                    `;
          container.appendChild(el);
        });

      } catch (e) {
        console.error(e);
        container.innerHTML = `<div class="full msg err">Erro de conex√£o</div>`;
      }
    }

    async function carregarHistorico() {
      const container = document.getElementById("historico-recente");
      try {
        const resp = await fetch(`${API_BASE}/patients/${usuario.id}/exercise-history?period_filter=last_7_days`);
        const data = await resp.json();

        if (resp.ok && data.has_data) {
          container.innerHTML = "";
          // Pegar os 3 √∫ltimos
          data.executions.slice(0, 3).forEach(exec => {
            const date = new Date(exec.execution_date).toLocaleDateString('pt-BR');
            const div = document.createElement("div");
            div.style.padding = "8px 0";
            div.style.borderBottom = "1px solid #f3f4f6";
            div.style.fontSize = "0.9rem";
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.innerHTML = `
                            <span>Running <b>${exec.exercise.name}</b></span>
                            <span style="color:#6b7280">${date}</span>
                        `;
            container.appendChild(div);
          });
        }
      } catch (e) {
        console.error("Erro ao carregar hist√≥rico", e);
      }
    }

    function logout() {
      localStorage.removeItem("moveon_usuario_logado");
      window.location.href = "/login";
    }

    document.addEventListener("DOMContentLoaded", () => {
      carregarExercicios();
      carregarHistorico();
      carregarFeedbackVideos();
    });

    async function carregarFeedbackVideos() {
      const container = document.getElementById("feedback-videos");
      const statusDiv = document.getElementById("feedback-videos-status");
      const noneDiv = document.getElementById("feedback-videos-none");
      statusDiv.style.display = "none";
      noneDiv.style.display = "none";
      try {
        // Endpoint sugerido: /api/patients/{id}/video-feedbacks
        const resp = await fetch(`${API_BASE}/patients/${usuario.id}/video-feedbacks`);
        if (!resp.ok) {
          container.innerHTML = `<div class=\"msg err\">Erro ao carregar feedbacks de v√≠deo</div>`;
          return;
        }
        const data = await resp.json();
        if (!data.length) {
          // Nenhum feedback, nenhum v√≠deo pendente
          statusDiv.style.display = "none";
          noneDiv.style.display = "block";
          return;
        }
        // Considera pendente quando ainda n√£o h√° sinal de an√°lise conclu√≠da
        let pendente = false;
        data.forEach(fb => {
          const status = (fb.status || "").toLowerCase();
          const temDados =
            (fb.observacoes && fb.observacoes.length) ||
            (fb.detalhes && Array.isArray(fb.detalhes) && fb.detalhes.length) ||
            (fb.repeticoes !== null && fb.repeticoes !== undefined);
          const concluido = status.includes("sucesso") || status.includes("success");
          if (!concluido && !temDados) pendente = true;
        });
        if (pendente) {
          statusDiv.style.display = "flex";
        } else {
          statusDiv.style.display = "none";
        }
        noneDiv.style.display = "none";
        container.querySelectorAll('.card').forEach(e=>e.remove());
        data.forEach(fb => {
          const div = document.createElement("div");
          div.className = "card";
          div.style.boxShadow = "none";
          div.style.border = "1px solid #e5e7eb";
          div.style.marginBottom = "10px";
          // Montar detalhes do feedback
          let obsHtml = '';
          if (fb.observacoes && fb.observacoes.length) {
            obsHtml = `<ul style='margin:6px 0 0 0; padding-left:18px; color:#374151; font-size:0.93em'>` +
              fb.observacoes.map(o => `<li>${o}</li>`).join('') + '</ul>';
          }
          let detalhesHtml = '';
          if (fb.detalhes && Array.isArray(fb.detalhes) && fb.detalhes.length) {
            detalhesHtml = `<details style='margin-top:6px'><summary>Detalhes das repeti√ß√µes</summary><ul style='margin:4px 0 0 0; padding-left:18px; color:#374151; font-size:0.92em'>` +
              fb.detalhes.map(rep => `<li>Rep ${rep.rep_index}: ${rep.note} (√Çngulo: ${rep.min_angle?.toFixed(1)}¬∞ - ${rep.max_angle?.toFixed(1)}¬∞)</li>`).join('') + '</ul></details>';
          }

          const status = (fb.status || "").toLowerCase();
          const concluido = status.includes("sucesso") || status.includes("success");
          const feedbackText = (fb.feedback || "").trim();
          const feedbackHtml = feedbackText
            ? feedbackText
            : (concluido ? "An√°lise conclu√≠da. Veja as observa√ß√µes abaixo." : "<span style='color:#f59e42'>Aguardando an√°lise...</span>");

          const exTitulo = (fb.exercise_name && String(fb.exercise_name).trim())
            ? fb.exercise_name
            : `Exerc√≠cio ID: ${fb.exercise_id || "?"}`;

          div.innerHTML = `
            <div style=\"font-size:0.95rem; color:#0369a1; margin-bottom:4px\"><b>${exTitulo}</b> (${fb.timestamp ? new Date(fb.timestamp).toLocaleString('pt-BR') : "data desconhecida"})</div>
            <div style=\"font-size:0.95rem; color:#374151; margin-bottom:4px\"><b>Status:</b> ${fb.status || "-"}</div>
            <div style=\"font-size:0.95rem; color:#374151; margin-bottom:4px\"><b>Feedback:</b> ${feedbackHtml}</div>
            <div style=\"font-size:0.95rem; color:#374151; margin-bottom:4px\"><b>Repeti√ß√µes detectadas:</b> ${fb.repeticoes ?? "-"}</div>
            ${obsHtml}
            ${detalhesHtml}
          `;
          container.appendChild(div);
        });
      } catch (e) {
        statusDiv.style.display = "none";
        noneDiv.style.display = "none";
        console.error(e);
        container.innerHTML = `<div class=\"msg err\">Erro de conex√£o ao buscar feedbacks</div>`;
      }
    }
  </script>
</body>

</html>