<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Minha √Årea - MoveOn</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .notif-container {
      position: relative;
      display: inline-block;
    }

    .notif-bell {
      background: #f3f4f6;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 999px;
      transition: background 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #4b5563;
      font-weight: 500;
    }

    .notif-bell:hover {
      background: #e5e7eb;
    }

    .notif-badge {
      background: #ef4444;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      font-weight: bold;
    }

    .notif-popup {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 320px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border: 1px solid #e5e7eb;
      display: none;
      z-index: 1000;
      max-height: 450px;
      overflow: hidden;
      flex-direction: column;
    }

    .notif-popup.active {
      display: flex;
    }

    .notif-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 700;
      background: #f9fafb;
      font-size: 1rem;
    }

    .notif-list {
      overflow-y: auto;
      flex: 1;
    }

    .notif-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.9rem;
      transition: background 0.1s;
      cursor: pointer;
    }

    .notif-item:hover {
      background: #f9fafb;
    }

    .notif-item.unread {
      background: #eff6ff;
      /* Fundo levemente azul para n√£o lidas */
      border-left: 4px solid #3b82f6;
    }

    .notif-item.read {
      opacity: 0.7;
    }

    .notif-item.unread .title {
      font-weight: 700;
      color: #111827;
    }

    .notif-item .text {
      color: #4b5563;
      line-height: 1.4;
    }

    .notif-item .date {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 6px;
    }

    .notif-empty {
      padding: 40px 20px;
      text-align: center;
      color: #9ca3af;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="top">
        <div>
          <h1>Ol√°, <span id="nome-paciente">Paciente</span> üëã</h1>
          <p class="sub">Bem-vindo ao seu painel de reabilita√ß√£o</p>
        </div>
        <div class="row-actions" style="margin-top:0; display: flex; align-items: center; gap: 10px;">
          <div class="notif-container">
            <button class="notif-bell" onclick="toggleNotificacoes()">
              <span>üîî</span>
              <span id="notif-count" class="notif-badge" style="display:none">0</span>
            </button>
            <div id="notif-popup" class="notif-popup">
              <div class="notif-header">Notifica√ß√µes</div>
              <div id="notif-list" class="notif-list">
                <div class="notif-empty">Carregando...</div>
              </div>
            </div>
          </div>
          <a href="/relatorio_meu" class="btn btn-secondary btn-small">üìà Meu Relat√≥rio</a>
          <a href="/paciente_metas" class="btn btn-secondary btn-small">üéØ Minhas Metas</a>
          <button onclick="logout()" class="btn btn-secondary btn-small">Sair</button>
        </div>
      </div>

      <div style="margin-top: 30px;">
        <h2 style="font-size: 1.2rem; margin-bottom: 15px;">Minhas Metas</h2>
        <div id="lista-metas-resumo" class="grid">
          <div style="text-align:center; padding: 20px; color: #6b7280;" class="full">Carregando metas...</div>
        </div>
      </div>

      <div style="margin-top: 30px;">
        <h2 style="font-size: 1.2rem; margin-bottom: 15px;">Meus Exerc√≠cios Ativos</h2>
        <div id="lista-exercicios" class="grid">
          <div style="text-align:center; padding: 20px; color: #6b7280;" class="full">Carregando seus exerc√≠cios...
          </div>
        </div>
      </div>

      <div style="margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
        <h3 style="font-size: 1rem; color: #4b5563;">Hist√≥rico Recente</h3>
        <div id="historico-recente" style="margin-top: 10px;">
          <p style="font-size: 0.9rem; color: #9ca3af;">Nenhuma atividade recente encontrada.</p>
        </div>
      </div>

      <div style="margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
        <h3 style="font-size: 1rem; color: #4b5563;">Feedback dos V√≠deos Enviados</h3>
        <div id="feedback-videos" style="margin-top: 10px;">
          <div id="feedback-videos-status"
            style="font-size: 0.9rem; color: #f59e42; display:none; align-items:center; gap:8px; margin-bottom:8px;">
            <span style="font-size:1.2em">‚è≥</span> Seu v√≠deo est√° sendo analisado, o feedback aparecer√° aqui em breve.
          </div>
          <div id="feedback-videos-none" style="font-size: 0.9rem; color: #9ca3af; display:none;">Nenhum v√≠deo pendente
            ou feedback encontrado.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.API_BASE = window.API_BASE || "http://127.0.0.1:8000/api";
    var API_BASE = window.API_BASE;
    const usuario = JSON.parse(localStorage.getItem("moveon_usuario_logado") || "null");

    if (!usuario || usuario.tipo !== "paciente") {
      window.location.href = "/login";
    }

    if (usuario && usuario.must_change_password) {
      window.location.href = "/trocar_senha?next=" + encodeURIComponent("/paciente_area");
    }

    document.getElementById("nome-paciente").textContent = usuario.nome;

    async function carregarExercicios() {
      const container = document.getElementById("lista-exercicios");
      try {
        const resp = await fetch(`${API_BASE}/patients/${usuario.id}/prescriptions?active_only=true`);
        const data = await resp.json();

        if (!resp.ok) {
          container.innerHTML = `<div class="full msg err">Erro ao carregar exerc√≠cios</div>`;
          return;
        }

        if (data.length === 0) {
          container.innerHTML = `<div class="full hint">Voc√™ n√£o tem exerc√≠cios prescritos no momento.</div>`;
          return;
        }

        container.innerHTML = "";
        data.forEach(p => {
          // Calcular se j√° fez hoje? (Futuro)

          const el = document.createElement("div");
          el.className = "card";
          el.style.boxShadow = "none";
          el.style.border = "1px solid #e5e7eb";
          el.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start">
                            <div>
                                <span class="badge badge-blue" style="margin-bottom:6px; display:inline-block">${p.exercise.category || "Geral"}</span>
                                <h3 style="margin:5px 0; font-size:1.1rem">${p.exercise.name}</h3>
                                <p style="font-size:0.9rem; color:#6b7280; margin:0">
                                    ${p.series} s√©ries de ${p.repetitions} repeti√ß√µes
                                </p>
                            </div>
                            <a href="/realizar_exercicio?prescription_id=${p.id}" class="btn btn-small">Come√ßar ‚ñ∂</a>
                        </div>
                        ${p.notes ? `<div style="margin-top:10px; font-size:0.85rem; color:#4b5563; background:#f9fafb; padding:8px; border-radius:8px">üìù ${p.notes}</div>` : ''}
                    `;
          container.appendChild(el);
        });

      } catch (e) {
        console.error(e);
        container.innerHTML = `<div class="full msg err">Erro de conex√£o</div>`;
      }
    }

    async function carregarHistorico() {
      const container = document.getElementById("historico-recente");
      try {
        const resp = await fetch(`${API_BASE}/patients/${usuario.id}/exercise-history?period_filter=last_7_days`);
        const data = await resp.json();

        if (resp.ok && data.has_data) {
          container.innerHTML = "";
          // Pegar os 3 √∫ltimos
          data.executions.slice(0, 3).forEach(exec => {
            const date = new Date(exec.execution_date).toLocaleDateString('pt-BR');
            const div = document.createElement("div");
            div.style.padding = "8px 0";
            div.style.borderBottom = "1px solid #f3f4f6";
            div.style.fontSize = "0.9rem";
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.innerHTML = `
                            <span>Running <b>${exec.exercise.name}</b></span>
                            <span style="color:#6b7280">${date}</span>
                        `;
            container.appendChild(div);
          });
        }
      } catch (e) {
        console.error("Erro ao carregar hist√≥rico", e);
      }
    }

    function logout() {
      localStorage.removeItem("moveon_usuario_logado");
      window.location.href = "/login";
    }

    document.addEventListener("DOMContentLoaded", () => {
      carregarExercicios();
      carregarHistorico();
      carregarFeedbackVideos();
      carregarMetasResumo();
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        carregarFeedbackVideos();
      } else {
        if (videoRefreshTimer) {
          clearInterval(videoRefreshTimer);
          videoRefreshTimer = null;
        }
      }
    });

    async function carregarMetasResumo() {
      const container = document.getElementById("lista-metas-resumo");
      try {
        const resp = await fetch(`${API_BASE}/pacientes/${usuario.id}/metas`);
        const data = await resp.json();

        if (!resp.ok) {
          container.innerHTML = `<div class="full msg err">Erro ao carregar metas</div>`;
          return;
        }

        if (data.length === 0) {
          container.innerHTML = `<div class="full hint">Voc√™ n√£o tem metas definidas no momento.</div>`;
          return;
        }

        container.innerHTML = "";
        // Mostrar apenas as 3 primeiras metas ativas ou em andamento
        const metasFiltradas = data.filter(m => m.status === 'ativa' || m.status === 'em_andamento').slice(0, 3);

        if (metasFiltradas.length === 0) {
          container.innerHTML = `<div class="full hint">Nenhuma meta ativa no momento.</div>`;
          return;
        }

        metasFiltradas.forEach(m => {
          const el = document.createElement("div");
          el.className = "card";
          el.style.boxShadow = "none";
          el.style.border = "1px solid #e5e7eb";
          el.style.padding = "15px";
          el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <h3 style="margin:0; font-size:1rem">${m.description}</h3>
                            <p style="font-size:0.85rem; color:#6b7280; margin:4px 0">Status: <b>${m.status}</b></p>
                        </div>
                        <a href="/paciente_metas" class="btn btn-secondary btn-small">Ver mais</a>
                    </div>
                `;
          container.appendChild(el);
        });
      } catch (e) {
        console.error(e);
        container.innerHTML = `<div class="full msg err">Erro de conex√£o</div>`;
      }
    }

    async function carregarFeedbackVideos() {
      const container = document.getElementById("feedback-videos");
      const statusDiv = document.getElementById("feedback-videos-status");
      const noneDiv = document.getElementById("feedback-videos-none");
      statusDiv.style.display = "none";
      noneDiv.style.display = "none";

      function escapeHtml(value) {
        const str = (value === undefined || value === null) ? "" : String(value);
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function renderProgress(fb) {
        const status = (fb.status || "").toLowerCase();
        const isPending = status.includes("pendente") || status.includes("process") || status.includes("running");
        const raw = (fb && fb.progress !== undefined && fb.progress !== null) ? Number(fb.progress) : NaN;
        if (!isPending || Number.isNaN(raw)) return "";
        const pct = Math.max(0, Math.min(100, Math.round(raw)));
        const frames = (fb.frames_done !== undefined && fb.frames_total)
          ? ` (${escapeHtml(fb.frames_done)}/${escapeHtml(fb.frames_total)} frames)`
          : "";
        return `
          <div style="margin:8px 0 10px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; color:#6b7280; margin-bottom:6px;">
              <span>Progresso da an√°lise</span>
              <span><b>${pct}%</b>${frames}</span>
            </div>
            <div style="height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden;">
              <div style="height:100%; width:${pct}%; background:#2563eb;"></div>
            </div>
          </div>
        `;
      }

      function isPendingWithProgress(fb) {
        const status = (fb.status || "").toLowerCase();
        const isPending = status.includes("pendente") || status.includes("process") || status.includes("running");
        const hasProgress = (fb.progress !== null && fb.progress !== undefined);
        return isPending && hasProgress;
      }

      function updateVideoAutoRefresh(shouldRun) {
        if (videoRefreshTimer) {
          clearInterval(videoRefreshTimer);
          videoRefreshTimer = null;
        }
        if (!shouldRun) return;
        videoRefreshTimer = setInterval(() => {
          if (document.visibilityState !== 'visible') return;
          carregarFeedbackVideos();
        }, 10000);
      }
      try {
        const resp = await fetch(`${API_BASE}/patients/${usuario.id}/video-feedbacks`);
        if (!resp.ok) {
          container.innerHTML = `<div class=\"msg err\">Erro ao carregar feedbacks de v√≠deo</div>`;
          return;
        }
        const data = await resp.json();
        if (!data.length) {
          statusDiv.style.display = "none";
          noneDiv.style.display = "block";
          return;
        }
        let pendente = false;
        let hasPendingProgress = false;
        data.forEach(fb => {
          const status = (fb.status || "").toLowerCase();
          const temDados =
            (fb.observacoes && fb.observacoes.length) ||
            (fb.detalhes && Array.isArray(fb.detalhes) && fb.detalhes.length) ||
            (fb.repeticoes !== null && fb.repeticoes !== undefined);
          const concluido = status.includes("sucesso") || status.includes("success");
          const hasProgress = (fb.progress !== null && fb.progress !== undefined);
          if (!concluido && (!temDados || hasProgress)) pendente = true;
          if (isPendingWithProgress(fb)) hasPendingProgress = true;
        });
        if (pendente) {
          statusDiv.style.display = "flex";
        } else {
          statusDiv.style.display = "none";
        }
        noneDiv.style.display = "none";
        container.querySelectorAll('.card').forEach(e => e.remove());
        data.forEach(fb => {
          const div = document.createElement("div");
          div.className = "card";
          div.style.boxShadow = "none";
          div.style.border = "1px solid #e5e7eb";
          div.style.marginBottom = "10px";
          let obsHtml = '';
          if (fb.observacoes && fb.observacoes.length) {
            obsHtml = `<ul style='margin:6px 0 0 0; padding-left:18px; color:#374151; font-size:0.93em'>` +
              fb.observacoes.map(o => `<li>${escapeHtml(o)}</li>`).join('') + '</ul>';
          }
          let detalhesHtml = '';
          if (fb.detalhes && Array.isArray(fb.detalhes) && fb.detalhes.length) {
            detalhesHtml = `<details style='margin-top:6px'><summary>Detalhes das repeti√ß√µes</summary><ul style='margin:4px 0 0 0; padding-left:18px; color:#374151; font-size:0.92em'>` +
              fb.detalhes.map(rep => `<li>Rep ${escapeHtml(rep.rep_index)}: ${escapeHtml(rep.note)} (√Çngulo: ${rep.min_angle?.toFixed?.(1) ?? rep.min_angle}¬∞ - ${rep.max_angle?.toFixed?.(1) ?? rep.max_angle}¬∞)</li>`).join('') + '</ul></details>';
          }

          const progressHtml = renderProgress(fb);

          const status = (fb.status || "").toLowerCase();
          const concluido = status.includes("sucesso") || status.includes("success");
          const feedbackText = (fb.feedback || "").trim();
          const feedbackHtml = feedbackText
            ? feedbackText
            : (concluido ? "An√°lise conclu√≠da. Veja as observa√ß√µes abaixo." : "<span style='color:#f59e42'>Aguardando an√°lise...</span>");

          const exTitulo = (fb.exercise_name && String(fb.exercise_name).trim())
            ? fb.exercise_name
            : `Exerc√≠cio ID: ${fb.exercise_id || "?"}`;

          div.innerHTML = `
            <div style="font-size:0.95rem; color:#0369a1; margin-bottom:4px"><b>${escapeHtml(exTitulo)}</b> (${fb.timestamp ? escapeHtml(new Date(fb.timestamp).toLocaleString('pt-BR')) : "data desconhecida"})</div>
            <div style="font-size:0.95rem; color:#374151; margin-bottom:4px"><b>Status:</b> ${escapeHtml(fb.status || "-")}</div>
            ${progressHtml}
            <div style="font-size:0.95rem; color:#374151; margin-bottom:4px"><b>Feedback:</b> ${feedbackHtml}</div>
            <div style="font-size:0.95rem; color:#374151; margin-bottom:4px"><b>Repeti√ß√µes detectadas:</b> ${escapeHtml(fb.repeticoes ?? "-")}</div>
            ${obsHtml}
            ${detalhesHtml}
          `;
          container.appendChild(div);
        });

        updateVideoAutoRefresh(hasPendingProgress);
      } catch (e) {
        updateVideoAutoRefresh(false);
        statusDiv.style.display = "none";
        noneDiv.style.display = "none";
        console.error(e);
        container.innerHTML = `<div class=\"msg err\">Erro de conex√£o ao buscar feedbacks</div>`;
      }
    }

    let videoRefreshTimer = null;

    // -------- NOTIFICA√á√ïES (Sininho) --------
    let notifAberta = false;

    function toggleNotificacoes() {
      notifAberta = !notifAberta;
      const popup = document.getElementById("notif-popup");
      if (notifAberta) {
        popup.classList.add("active");
        carregarNotificacoesSininho();
      } else {
        popup.classList.remove("active");
      }
    }

    // Fechar popup ao clicar fora
    document.addEventListener("click", (e) => {
      const container = document.querySelector(".notif-container");
      if (notifAberta && !container.contains(e.target)) {
        toggleNotificacoes();
      }
    });

    async function carregarNotificacoesSininho() {
      const listEl = document.getElementById("notif-list");
      const countEl = document.getElementById("notif-count");

      try {
        const resp = await fetch(`${API_BASE}/pacientes/${usuario.id}/notificacoes`);
        const data = await resp.json();

        if (!resp.ok) return;

        if (data.length === 0) {
          listEl.innerHTML = '<div class="notif-empty">Nenhuma notifica√ß√£o por enquanto.</div>';
          countEl.style.display = "none";
          return;
        }

        // Contar apenas n√£o lidas
        const unreadCount = data.filter(n => !n.lida).length;
        if (unreadCount > 0) {
          countEl.textContent = unreadCount;
          countEl.style.display = "block";
        } else {
          countEl.style.display = "none";
        }

        listEl.innerHTML = "";
        data.forEach(n => {
          const item = document.createElement("div");
          item.className = `notif-item ${n.lida ? 'read' : 'unread'}`;

          // Formatar data
          let dataFormatada = "";
          try {
            dataFormatada = new Date(n.data_hora).toLocaleString('pt-BR');
          } catch (e) { dataFormatada = n.data_hora; }

          item.innerHTML = `
                    <div class="title">${n.tipo.replace(/_/g, ' ').toUpperCase()}</div>
                    <div class="text">${n.mensagem}</div>
                    <div class="date">${dataFormatada}</div>
                `;

          item.onclick = async () => {
            if (!n.lida) {
              await marcarComoLida(n.id);
              carregarNotificacoesSininho();
            }
          };

          listEl.appendChild(item);
        });

      } catch (e) {
        console.error("Erro ao carregar notifica√ß√µes:", e);
      }
    }

    async function marcarComoLida(id) {
      try {
        await fetch(`${API_BASE}/notificacoes/${id}/lida`, { method: "PATCH" });
      } catch (e) {
        console.error("Erro ao marcar como lida:", e);
      }
    }

    // Carregar contagem inicial
    setTimeout(carregarNotificacoesSininho, 500);
  </script>
</body>

</html>